{% extends "base.html" %}

{% block title %}{{ "Comprar Créditos" }}{% endblock %}

{% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="fixed top-0 left-0 right-0 z-50 bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center space-x-4">
                <a href="https://agathoscreative.com" class="flex items-center" title="Agathos Creative">
                    <img src="/viralpost/static/images/logo.png" alt="Agathos" class="h-8 w-8 object-contain opacity-60 hover:opacity-100 transition">
                </a>
                <span class="font-bold text-xl gradient-text">Créditos</span>
            </div>
            <div class="flex items-center space-x-6">
                <a href="/viralpost/app" class="text-gray-600 hover:text-purple-600 flex items-center">
                    <i class="fas fa-image mr-2"></i>ViralPost
                </a>
                <a href="/viralpost/soundai/app" class="text-gray-600 hover:text-pink-600 flex items-center">
                    <i class="fas fa-music mr-2"></i>SoundAI
                </a>
                <a id="backBtn" href="/viralpost/app" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200">
                    <i class="fas fa-arrow-left mr-2"></i><span data-i18n="nav.app">Volver</span>
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="pt-24 pb-12 px-4 bg-gray-50 min-h-screen">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center bg-purple-100 text-purple-600 px-4 py-2 rounded-full mb-4">
                <i class="fas fa-coins mr-2"></i>
                <span><span data-i18n="credits.balance">Tu saldo</span>: <strong id="currentCredits">0</strong> <span data-i18n="credits.pack">créditos</span></span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold mb-4" data-i18n="credits.title">Comprar Créditos</h1>
            <p class="text-gray-600 text-lg" id="creditsSubtitle">1 crédito = 1 imagen viral o 1 canción generada con IA</p>
        </div>

        <!-- Paquetes (dinámico) -->
        <div id="packagesGrid" class="grid md:grid-cols-4 gap-6 mb-12">
            <!-- Loading state -->
            <div class="col-span-4 text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-500" data-i18n="loading">Cargando paquetes...</p>
            </div>
        </div>

        <!-- Info adicional -->
        <div class="bg-white rounded-2xl p-8 shadow-lg">
            <div class="grid md:grid-cols-3 gap-8">
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold mb-2" data-i18n="credits.secure">Pago Seguro</h3>
                    <p class="text-gray-600 text-sm" data-i18n="credits.secure_desc">Procesado con Stripe, el estándar de seguridad en pagos</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-infinity text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold mb-2" data-i18n="credits.no_expiry">Sin Expiración</h3>
                    <p class="text-gray-600 text-sm" data-i18n="credits.no_expiry_desc">Tus créditos nunca expiran, úsalos cuando quieras</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-bolt text-purple-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold mb-2" data-i18n="credits.instant">Créditos Inmediatos</h3>
                    <p class="text-gray-600 text-sm" data-i18n="credits.instant_desc">Tus créditos se agregan automáticamente al pagar</p>
                </div>
            </div>
        </div>

        <!-- Nota sobre OXXO (solo MXN) -->
        <div id="oxxoNote" class="mt-6 bg-orange-50 rounded-xl p-4 text-center hidden">
            <p class="text-orange-800 text-sm">
                <i class="fas fa-store mr-2"></i>
                <span data-i18n="credits.oxxo_note">También puedes pagar en OXXO (solo disponible en México)</span>
            </p>
        </div>

        <!-- Historial de compras -->
        <div class="mt-12">
            <h2 class="text-xl font-bold mb-4" data-i18n="history.purchases">Historial de Compras</h2>
            <div id="transactionHistory" class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-8 text-center text-gray-500" id="noTransactions">
                    <i class="fas fa-receipt text-4xl mb-4"></i>
                    <p data-i18n="history.no_purchases">Aún no tienes compras</p>
                </div>
                <table id="transactionsTable" class="hidden w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="history.date">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="credits.pack">Créditos</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="history.amount">Monto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="history.status">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Modal de carga -->
<div id="loadingModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-600" data-i18n="payment.redirecting">Redirigiendo a Stripe...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Obtener parámetro 'from' para saber de dónde viene el usuario
    const urlParams = new URLSearchParams(window.location.search);
    const fromPage = urlParams.get('from') || 'viralpost';

    // Configurar botón de regreso
    const backBtn = document.getElementById('backBtn');
    if (fromPage === 'soundai') {
        backBtn.href = '/viralpost/soundai/app';
    } else {
        backBtn.href = '/viralpost/app';
    }

    // Verificar autenticación
    if (!Auth.isLoggedIn()) {
        const redirect = fromPage === 'soundai' ? '/viralpost/soundai/app' : '/viralpost/app';
        window.location.href = `/viralpost/login?redirect=${encodeURIComponent(redirect)}`;
    }

    let packagesData = [];

    // Cargar datos
    document.addEventListener('DOMContentLoaded', async () => {
        await loadUserData();
        await loadPackages();
        await loadTransactions();

        // Actualizar cuando cambie el idioma
        window.addEventListener('languageChanged', async () => {
            await loadPackages();
            updateUIText();
        });
    });

    function updateUIText() {
        // Actualizar subtítulo
        const subtitle = document.getElementById('creditsSubtitle');
        if (window.I18n) {
            subtitle.textContent = I18n.currentLang === 'en'
                ? '1 credit = 1 viral image or 1 AI-generated song'
                : '1 crédito = 1 imagen viral o 1 canción generada con IA';
        }

        // Mostrar/ocultar nota de OXXO según moneda
        const oxxoNote = document.getElementById('oxxoNote');
        if (window.I18n && I18n.currentCurrency === 'MXN') {
            oxxoNote.classList.remove('hidden');
        } else {
            oxxoNote.classList.add('hidden');
        }
    }

    async function loadUserData() {
        try {
            const response = await apiFetch('/auth/me');
            if (response.ok) {
                const user = await response.json();
                document.getElementById('currentCredits').textContent = user.creditos;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadPackages() {
        try {
            const currency = window.I18n ? I18n.currentCurrency : 'MXN';
            const lang = window.I18n ? I18n.currentLang : 'es';

            const response = await apiFetch(`/pagos/paquetes?currency=${currency}&lang=${lang}`);
            if (response.ok) {
                packagesData = await response.json();
                renderPackages(packagesData);
                updateUIText();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderPackages(packages) {
        const grid = document.getElementById('packagesGrid');
        const lang = window.I18n ? I18n.currentLang : 'es';

        grid.innerHTML = packages.map(p => {
            const isPopular = p.popular;
            const isBestValue = p.mejor_valor;
            const pricePerCredit = (p.precio / p.creditos).toFixed(2);

            let borderClass = 'border-gray-200 hover:border-purple-300';
            let bgClass = 'bg-white';
            let badgeHtml = '';
            let buttonClass = 'bg-gray-100 text-gray-700 hover:bg-gray-200';

            if (isPopular) {
                borderClass = 'border-purple-400';
                badgeHtml = `<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full">${lang === 'en' ? 'POPULAR' : 'POPULAR'}</div>`;
                buttonClass = 'gradient-bg text-white hover:opacity-90';
            } else if (isBestValue) {
                borderClass = 'border-yellow-400';
                bgClass = 'bg-gradient-to-br from-yellow-50 to-amber-50';
                badgeHtml = `<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white text-xs font-bold px-3 py-1 rounded-full">${lang === 'en' ? 'BEST VALUE' : 'MEJOR VALOR'}</div>`;
                buttonClass = 'bg-yellow-500 text-white hover:bg-yellow-600';
            }

            const currencySymbol = p.moneda === 'USD' ? '$' : '$';
            const priceFormatted = p.moneda === 'USD'
                ? `${currencySymbol}${p.precio.toFixed(2)}`
                : `${currencySymbol}${Math.round(p.precio).toLocaleString('es-MX')}`;

            const perImageText = lang === 'en' ? 'per image' : 'por imagen';
            const generationsText = lang === 'en' ? 'generations' : 'generaciones';
            const copyText = lang === 'en' ? 'Copy included' : 'Copy incluido';
            const noExpiryText = lang === 'en' ? 'No expiration' : 'Sin expiración';
            const selectText = lang === 'en' ? 'Select' : 'Seleccionar';

            return `
                <div class="package-card ${bgClass} rounded-2xl p-6 border-2 ${borderClass} relative cursor-pointer transition"
                     data-package="${p.id}">
                    ${badgeHtml}
                    <h3 class="font-bold text-lg mb-2">${p.nombre}</h3>
                    <div class="text-3xl font-bold mb-1">${priceFormatted} <span class="text-lg font-normal text-gray-500">${p.moneda}</span></div>
                    <p class="text-gray-500 text-sm mb-4">${currencySymbol}${pricePerCredit} ${perImageText}</p>
                    <ul class="text-sm text-gray-600 space-y-2 mb-6">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>${p.creditos} ${generationsText}</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>${copyText}</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>${noExpiryText}</li>
                    </ul>
                    <button class="w-full ${buttonClass} py-3 rounded-xl font-medium transition buy-btn">
                        ${selectText}
                    </button>
                </div>
            `;
        }).join('');

        setupPackageCards();
    }

    async function loadTransactions() {
        try {
            const response = await apiFetch('/pagos/historial');
            if (response.ok) {
                const transactions = await response.json();
                if (transactions.length > 0) {
                    renderTransactions(transactions);
                }
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderTransactions(transactions) {
        document.getElementById('noTransactions').classList.add('hidden');
        document.getElementById('transactionsTable').classList.remove('hidden');

        const lang = window.I18n ? I18n.currentLang : 'es';
        const locale = lang === 'en' ? 'en-US' : 'es-MX';

        const tbody = document.getElementById('transactionsBody');
        tbody.innerHTML = transactions.map(t => {
            const date = new Date(t.created_at).toLocaleDateString(locale, {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });

            const statusColors = {
                'completada': 'bg-green-100 text-green-800',
                'pendiente': 'bg-yellow-100 text-yellow-800',
                'fallida': 'bg-red-100 text-red-800'
            };

            const statusText = {
                es: { completada: 'Completada', pendiente: 'Pendiente', fallida: 'Fallida' },
                en: { completada: 'Completed', pendiente: 'Pending', fallida: 'Failed' }
            };

            const creditsText = lang === 'en' ? 'credits' : 'créditos';

            return `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${date}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${t.creditos} ${creditsText}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">$${t.monto_mxn} MXN</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[t.estado] || 'bg-gray-100'}">
                            ${statusText[lang][t.estado] || t.estado}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function setupPackageCards() {
        document.querySelectorAll('.package-card').forEach(card => {
            card.addEventListener('click', () => {
                const packageId = card.dataset.package;
                purchasePackage(packageId);
            });
        });
    }

    async function purchasePackage(packageId) {
        document.getElementById('loadingModal').classList.remove('hidden');

        const currency = window.I18n ? I18n.currentCurrency : 'MXN';
        const lang = window.I18n ? I18n.currentLang : 'es';

        try {
            const response = await apiFetch('/pagos/checkout', {
                method: 'POST',
                body: JSON.stringify({
                    paquete_id: packageId,
                    currency: currency,
                    lang: lang
                })
            });

            if (response.ok) {
                const data = await response.json();
                // Redirigir a Stripe Checkout
                window.location.href = data.checkout_url;
            } else {
                const error = await response.json();
                const errorMsg = lang === 'en' ? 'Error processing request' : 'Error al procesar';
                showNotification(error.detail || errorMsg, 'error');
                document.getElementById('loadingModal').classList.add('hidden');
            }
        } catch (error) {
            const errorMsg = lang === 'en' ? 'Connection error' : 'Error de conexión';
            showNotification(errorMsg, 'error');
            document.getElementById('loadingModal').classList.add('hidden');
        }
    }
</script>
{% endblock %}
