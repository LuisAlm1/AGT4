{% extends "base.html" %}

{% block title %}Historial - SoundAI{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="fixed top-0 left-0 right-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center space-x-4">
                <a href="https://agathoscreative.com" class="flex items-center" title="Agathos Creative">
                    <img src="/viralpost/static/images/logo.png" alt="Agathos" class="h-8 w-8 object-contain opacity-60 hover:opacity-100 transition">
                </a>
                <a href="/viralpost/soundai" class="flex items-center space-x-2">
                    <div class="h-8 w-8 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-music text-white"></i>
                    </div>
                    <span class="font-bold text-xl bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">SoundAI</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/viralpost/soundai" class="text-gray-600 hover:text-gray-900 font-medium">
                    <i class="fas fa-plus mr-1"></i> Nueva
                </a>
                <a href="/viralpost/creditos?from=soundai" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900">
                    <i class="fas fa-coins text-yellow-500"></i>
                    <span id="creditCount" class="font-medium">0</span>
                </a>
                <a href="/viralpost/app" class="text-gray-500 hover:text-purple-600" title="ViralPost AI">
                    <i class="fas fa-image"></i>
                </a>
                <button onclick="logoutSoundAI()" class="text-gray-400 hover:text-red-500" title="Cerrar sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<main class="pt-24 pb-12 px-4 min-h-screen bg-gradient-to-br from-gray-50 to-purple-50">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-history text-purple-500 mr-2"></i>
                Historial de Música
            </h1>
            <p class="text-gray-600">Todas tus canciones generadas con SoundAI</p>
        </div>

        <!-- Lista de canciones -->
        <div id="historyList" class="space-y-4">
            <!-- Loading -->
            <div id="historyLoading" class="text-center py-12">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                    <i class="fas fa-compact-disc text-2xl text-purple-500 animate-spin"></i>
                </div>
                <p class="text-gray-500">Cargando historial...</p>
            </div>
        </div>

        <!-- Empty state -->
        <div id="historyEmpty" class="hidden text-center py-12">
            <div class="w-24 h-24 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-music text-4xl text-purple-300"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">Aún no has generado música</h3>
            <p class="text-gray-500 mb-6">Crea tu primera canción con SoundAI</p>
            <a href="/viralpost/soundai" class="inline-flex items-center bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl font-medium hover:opacity-90 transition">
                <i class="fas fa-plus mr-2"></i>Generar Música
            </a>
        </div>

        <!-- Pagination info -->
        <div id="paginationInfo" class="hidden text-center text-gray-500 text-sm mt-6">
            Mostrando <span id="showCount">0</span> canciones
        </div>
    </div>
</main>

<!-- Player modal -->
<div id="playerModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 px-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full">
        <div class="flex justify-between items-start mb-4">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Canción</h3>
            <button onclick="closePlayer()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 mb-4">
            <div class="flex items-center justify-center mb-4">
                <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-music text-3xl text-white"></i>
                </div>
            </div>
            <audio id="modalPlayer" controls class="w-full">
                Tu navegador no soporta el elemento de audio.
            </audio>
        </div>

        <div class="space-y-2 text-sm mb-4">
            <div class="flex justify-between">
                <span class="text-gray-500">Género:</span>
                <span id="modalGenre" class="font-medium text-gray-800">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Mood:</span>
                <span id="modalMood" class="font-medium text-gray-800">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Duración:</span>
                <span id="modalDuration" class="font-medium text-gray-800">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Fecha:</span>
                <span id="modalDate" class="font-medium text-gray-800">-</span>
            </div>
        </div>

        <div class="flex space-x-3">
            <a id="modalDownload" href="#" download class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-medium text-center hover:opacity-90 transition">
                <i class="fas fa-download mr-2"></i>Descargar
            </a>
            <button onclick="closePlayer()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition">
                Cerrar
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Verificar autenticación
    if (!Auth.isLoggedIn()) {
        window.location.href = '/viralpost/login?redirect=/viralpost/soundai/historial';
    }

    let generaciones = [];

    // Cargar datos
    async function loadData() {
        try {
            // Cargar usuario
            const userResponse = await apiFetch('/auth/me');
            if (userResponse.ok) {
                const user = await userResponse.json();
                Auth.setUser(user);
                document.getElementById('creditCount').textContent = user.creditos;
            }

            // Cargar historial
            const historyResponse = await apiFetch('/music/historial?limit=50');
            if (historyResponse.ok) {
                const data = await historyResponse.json();
                generaciones = data.generaciones || [];
                renderHistory();
            }
        } catch (error) {
            console.error('Error cargando datos:', error);
            showNotification('Error al cargar el historial', 'error');
        }
    }

    function renderHistory() {
        const container = document.getElementById('historyList');
        const loading = document.getElementById('historyLoading');
        const empty = document.getElementById('historyEmpty');
        const pagination = document.getElementById('paginationInfo');

        loading.classList.add('hidden');

        if (generaciones.length === 0) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');
        pagination.classList.remove('hidden');
        document.getElementById('showCount').textContent = generaciones.length;

        container.innerHTML = generaciones.map((g, index) => `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition cursor-pointer"
                 onclick="openPlayer(${index})">
                <div class="flex items-center space-x-4">
                    <!-- Icon -->
                    <div class="w-14 h-14 bg-gradient-to-br from-purple-100 to-pink-100 rounded-xl flex items-center justify-center flex-shrink-0">
                        ${g.estado === 'completada'
                            ? '<i class="fas fa-music text-2xl text-purple-500"></i>'
                            : g.estado === 'error'
                                ? '<i class="fas fa-exclamation-circle text-2xl text-red-500"></i>'
                                : '<i class="fas fa-spinner text-2xl text-gray-400 animate-spin"></i>'
                        }
                    </div>

                    <!-- Info -->
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-gray-800 truncate">${escapeHtml(g.titulo)}</h3>
                        <p class="text-gray-500 text-sm truncate">${escapeHtml(g.descripcion || 'Sin descripción')}</p>
                        <div class="flex items-center space-x-3 mt-1 text-xs text-gray-400">
                            <span><i class="fas fa-clock mr-1"></i>${g.duracion_segundos}s</span>
                            ${g.genero ? `<span><i class="fas fa-tag mr-1"></i>${g.genero}</span>` : ''}
                            ${g.es_instrumental ? '<span><i class="fas fa-guitar mr-1"></i>Instrumental</span>' : ''}
                        </div>
                    </div>

                    <!-- Status / Play -->
                    <div class="flex-shrink-0">
                        ${g.estado === 'completada' && g.audio_url
                            ? '<div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full flex items-center justify-center"><i class="fas fa-play text-white ml-1"></i></div>'
                            : g.estado === 'error'
                                ? '<span class="text-red-500 text-xs">Error</span>'
                                : '<span class="text-gray-400 text-xs">Procesando</span>'
                        }
                    </div>
                </div>
            </div>
        `).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function openPlayer(index) {
        const g = generaciones[index];
        if (g.estado !== 'completada' || !g.audio_url) return;

        document.getElementById('modalTitle').textContent = g.titulo;
        document.getElementById('modalPlayer').src = g.audio_url;
        document.getElementById('modalGenre').textContent = g.genero || '-';
        document.getElementById('modalMood').textContent = g.mood || '-';
        document.getElementById('modalDuration').textContent = `${g.duracion_segundos} segundos`;
        document.getElementById('modalDate').textContent = g.created_at
            ? new Date(g.created_at).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' })
            : '-';

        document.getElementById('modalDownload').href = g.audio_url;
        document.getElementById('modalDownload').download = `${g.titulo.replace(/[^a-z0-9]/gi, '_')}.mp3`;

        document.getElementById('playerModal').classList.remove('hidden');
    }

    function closePlayer() {
        const player = document.getElementById('modalPlayer');
        player.pause();
        player.src = '';
        document.getElementById('playerModal').classList.add('hidden');
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePlayer();
    });

    // Close modal on backdrop click
    document.getElementById('playerModal').addEventListener('click', (e) => {
        if (e.target.id === 'playerModal') closePlayer();
    });

    // Logout específico para SoundAI
    function logoutSoundAI() {
        Auth.removeToken();
        window.location.href = '/viralpost/soundai';
    }

    loadData();
</script>
{% endblock %}
